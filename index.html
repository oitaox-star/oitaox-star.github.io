<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>WebAR（固定マーカー + アップロード表示物）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,"Noto Sans JP",sans-serif;
      background:#000;
      color:#fff;
      overflow:hidden;
    }
    #ar-container{
      position:fixed;
      inset:0;
    }
    a-scene{
      width:100%;
      height:100%;
    }
    /* オーバーレイUI */
    #ui{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    #ui-inner{
      pointer-events:auto;
      width:min(480px,100% - 32px);
      padding:16px 20px;
      border-radius:12px;
      background:rgba(0,0,0,0.82);
      box-shadow:0 12px 40px rgba(0,0,0,0.6);
      backdrop-filter:blur(10px);
    }
    h1{
      margin:0 0 8px;
      font-size:18px;
    }
    p{
      margin:4px 0;
      font-size:13px;
      color:#ccc;
    }
    label{
      display:block;
      margin-top:10px;
      font-size:13px;
    }
    select,input[type="file"]{
      width:100%;
      margin-top:4px;
      font-size:13px;
    }
    button{
      margin-top:14px;
      width:100%;
      padding:10px 0;
      font-size:15px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#ffcc66;
      color:#222;
      font-weight:600;
    }
    button:disabled{
      background:#777;
      cursor:not-allowed;
    }
    #status{
      margin-top:6px;
      font-size:12px;
      color:#ffcc66;
    }
    #small-note{
      margin-top:8px;
      font-size:11px;
      color:#aaa;
    }
  </style>
</head>
<body>
  <!-- ARシーン：マーカーは固定（targets.mind） -->
  <div id="ar-container">
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <a-assets>
        <!-- アップロードされたコンテンツ -->
        <a-asset-item id="userModel"></a-asset-item>
        <img id="userImage">
        <video id="userVideo" loop muted playsinline webkit-playsinline></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- マーカーの位置に出るエンティティ（ターゲットは index:0 固定） -->
      <a-entity id="marker-root" mindar-image-target="targetIndex: 0">
        <!-- 3Dモデル -->
        <a-gltf-model id="modelEntity"
          src="#userModel"
          visible="false"
          position="0 0 0"
          rotation="0 0 0"
          scale="0.1 0.1 0.1">
        </a-gltf-model>

        <!-- 画像 -->
        <a-plane id="imageEntity"
          src="#userImage"
          visible="false"
          position="0 0 0"
          rotation="0 0 0"
          width="1"
          height="0.7">
        </a-plane>

        <!-- 動画 -->
        <a-plane id="videoEntity"
          visible="false"
          position="0 0 0"
          rotation="0 0 0"
          width="1"
          height="0.7"
          material="src: #userVideo">
        </a-plane>
      </a-entity>
    </a-scene>
  </div>

  <!-- UI：表示物だけアップロード -->
  <div id="ui">
    <div id="ui-inner">
      <h1>WebAR：表示物アップロード</h1>
      <p>固定マーカー（targets.mind）に対して、表示する3Dモデル / 画像 / 動画だけをアップロードします。</p>

      <label>コンテンツの種類</label>
      <select id="contentType">
        <option value="model">3Dモデル（.glb / .gltf）</option>
        <option value="image">画像（.png / .jpg / .jpeg）</option>
        <option value="video">動画（.mp4 / .webm）</option>
      </select>

      <label>コンテンツファイル</label>
      <input type="file" id="contentFile"
        accept=".glb,.gltf,.png,.jpg,.jpeg,.mp4,.webm">

      <button id="startButton">このコンテンツでARを開始</button>
      <div id="status"></div>
      <div id="small-note">
        ※ このHTMLと同じフォルダに targets.mind を置いてください。<br>
        ※ HTTPS または localhost で開いてください。<br>
        ※ カメラ許可を求められたら「許可」を押してください。
      </div>
    </div>
  </div>

  <script>
    const contentTypeSelect = document.getElementById("contentType");
    const contentInput = document.getElementById("contentFile");
    const startButton = document.getElementById("startButton");
    const statusEl = document.getElementById("status");
    const ui = document.getElementById("ui");

    const userModelAsset = document.getElementById("userModel");
    const userImageAsset = document.getElementById("userImage");
    const userVideoAsset = document.getElementById("userVideo");

    const modelEntity = document.getElementById("modelEntity");
    const imageEntity = document.getElementById("imageEntity");
    const videoEntity = document.getElementById("videoEntity");

    function setStatus(msg){
      statusEl.textContent = msg || "";
    }

    function hideAllEntities(){
      modelEntity.setAttribute("visible", "false");
      imageEntity.setAttribute("visible", "false");
      videoEntity.setAttribute("visible", "false");
    }

    // コンテンツ種別によって accept を変える（任意）
    contentTypeSelect.addEventListener("change", () => {
      const type = contentTypeSelect.value;
      if (type === "model") {
        contentInput.setAttribute("accept", ".glb,.gltf");
      } else if (type === "image") {
        contentInput.setAttribute("accept", ".png,.jpg,.jpeg");
      } else if (type === "video") {
        contentInput.setAttribute("accept", ".mp4,.webm");
      }
      contentInput.value = "";
      setStatus("");
    });

    contentInput.addEventListener("change", () => {
      if (contentInput.files[0]) {
        setStatus(`選択: ${contentInput.files[0].name}`);
      }
    });

    startButton.addEventListener("click", () => {
      const file = contentInput.files[0];
      const type = contentTypeSelect.value;

      if (!file) {
        setStatus("コンテンツファイルを選択してください。");
        return;
      }

      setStatus("ファイルを読み込み中…");

      const contentUrl = URL.createObjectURL(file);
      hideAllEntities();

      if (type === "model") {
        userModelAsset.setAttribute("src", contentUrl);
        modelEntity.setAttribute("visible", "true");
        setStatus("3Dモデルを設定しました。マーカーをかざしてください。");

      } else if (type === "image") {
        userImageAsset.setAttribute("src", contentUrl);
        imageEntity.setAttribute("visible", "true");
        setStatus("画像を設定しました。マーカーをかざしてください。");

      } else if (type === "video") {
        userVideoAsset.setAttribute("src", contentUrl);

        // iOS対策：ユーザー操作中に再生開始要求
        userVideoAsset.play().catch(err => {
          console.warn("動画の自動再生に失敗しました:", err);
        });

        videoEntity.setAttribute("visible", "true");
        setStatus("動画を設定しました。マーカーをかざしてください。");
      }

      // UIを閉じる（そのまま残したければこの行をコメントアウト）
      ui.style.display = "none";
    });
  </script>
</body>
</html>


