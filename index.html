<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebAR (Marker) + Touch Rotate/Scale</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <!-- AR.js for A-Frame -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- Gesture detector (touch drag / pinch) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-gesture-detector-component@master/dist/aframe-gesture-detector-component.min.js"></script>

  <script>
    // 1本指ドラッグ: 回転 / 2本指ピンチ: 拡大縮小
    AFRAME.registerComponent('gesture-handler', {
      schema: {
        minScale: { default: 0.3 },
        maxScale: { default: 3.0 },
        rotSpeed: { default: 0.01 },  // 回転の感度
        scaleSpeed: { default: 0.005 } // 拡縮の感度
      },

      init: function () {
        const el = this.el;

        this.state = {
          rotX: el.object3D.rotation.x,
          rotY: el.object3D.rotation.y,
          scale: el.object3D.scale.x || 1
        };

        this.onOneFingerMove = this.onOneFingerMove.bind(this);
        this.onTwoFingerMove = this.onTwoFingerMove.bind(this);

        // シーンが gesture-detector を持っている前提でイベントを受ける
        el.sceneEl.addEventListener('onefingermove', this.onOneFingerMove);
        el.sceneEl.addEventListener('twofingermove', this.onTwoFingerMove);
      },

      remove: function () {
        this.el.sceneEl.removeEventListener('onefingermove', this.onOneFingerMove);
        this.el.sceneEl.removeEventListener('twofingermove', this.onTwoFingerMove);
      },

      onOneFingerMove: function (e) {
        // マーカー未検出中は触っても動かさない
        if (!this.el.object3D.visible) return;

        const d = e.detail.positionChange; // {x, y}
        this.state.rotY += d.x * this.data.rotSpeed;
        this.state.rotX += d.y * this.data.rotSpeed;

        this.el.object3D.rotation.set(this.state.rotX, this.state.rotY, 0);
      },

      onTwoFingerMove: function (e) {
        if (!this.el.object3D.visible) return;

        const spreadChange = e.detail.spreadChange;
        this.state.scale += spreadChange * this.data.scaleSpeed;

        // 範囲制限
        this.state.scale = Math.min(this.data.maxScale, Math.max(this.data.minScale, this.state.scale));

        this.el.object3D.scale.set(this.state.scale, this.state.scale, this.state.scale);
      }
    });
  </script>
</head>

<body style="margin:0; overflow:hidden;">
  <a-scene
    embedded
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; debugUIEnabled: false;"
    gesture-detector
  >
    <a-assets>
      <!-- フォルダ構造に合わせて固定 -->
      <a-asset-item id="model-asset" src="assets/model.glb"></a-asset-item>
    </a-assets>

    <!-- フォルダ構造に合わせて固定 -->
    <a-marker type="pattern" url="assets/marker.patt">
      <a-entity
        id="model"
        gltf-model="#model-asset"
        position="0 0 0"
        rotation="0 0 0"
        scale="1 1 1"
        gesture-handler
      ></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
